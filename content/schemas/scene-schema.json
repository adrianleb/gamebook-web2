{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/adrianleb/gamebook-web2/content/schemas/scene-schema.json",
  "title": "Gamebook Scene",
  "description": "Individual scene data including text, choices, conditions, and effects for The Understage gamebook",
  "type": "object",
  "required": ["id", "title", "text", "choices"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference for validation"
    },
    "id": {
      "type": "string",
      "description": "Unique scene identifier (format: sc_<chapter>_<slug> or bk_<source>_<number>)",
      "pattern": "^(sc_|bk_)[a-z0-9_-]+$"
    },
    "title": {
      "type": "string",
      "description": "Scene title displayed to player",
      "minLength": 1
    },
    "location": {
      "type": "string",
      "description": "Optional location name for context"
    },
    "text": {
      "type": "string",
      "description": "Scene narrative text. Supports inline markup: [bold], {italic}, _underline_, |choice highlight|",
      "minLength": 1,
      "maxLength": 10000
    },
    "art": {
      "type": "string",
      "description": "Optional path to scene art image"
    },
    "music": {
      "type": "string",
      "description": "Optional music track identifier"
    },
    "sfx": {
      "type": "array",
      "description": "Optional sound effects to play on scene entry",
      "items": {
        "type": "string"
      }
    },
    "onEnter": {
      "description": "Effects applied when scene is entered",
      "oneOf": [
        {
          "type": "array",
          "items": {
            "$ref": "#/$defs/effect"
          }
        },
        {
          "$ref": "#/$defs/effect"
        }
      ]
    },
    "onExit": {
      "description": "Effects applied when leaving scene",
      "oneOf": [
        {
          "type": "array",
          "items": {
            "$ref": "#/$defs/effect"
          }
        },
        {
          "$ref": "#/$defs/effect"
        }
      ]
    },
    "choices": {
      "type": "array",
      "description": "Available choices from this scene",
      "minItems": 0,
      "items": {
        "type": "object",
        "required": ["label", "to"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Optional choice identifier for testing/debugging"
          },
          "label": {
            "type": "string",
            "description": "Choice button text (supports inline markup)",
            "minLength": 1
          },
          "to": {
            "type": "string",
            "description": "Target scene ID",
            "pattern": "^(sc_|bk_)[a-z0-9_-]+$"
          },
          "conditions": {
            "description": "Conditions that must be met for choice to be available",
            "$ref": "#/$defs/conditionGroup"
          },
          "disabledHint": {
            "type": "string",
            "description": "Text shown when choice is disabled (required if conditions exist)"
          },
          "onChoose": {
            "description": "Effects applied when this choice is selected",
            "oneOf": [
              {
                "type": "array",
                "items": {
                  "$ref": "#/$defs/effect"
                }
              },
              {
                "$ref": "#/$defs/effect"
              }
            ]
          },
          "style": {
            "type": "string",
            "enum": ["default", "primary", "danger", "special"],
            "description": "Visual style variant for the choice button",
            "default": "default"
          },
          "icon": {
            "type": "string",
            "description": "Optional icon identifier for the choice"
          }
        }
      }
    },
    "tags": {
      "type": "array",
      "description": "Optional tags for categorization (e.g., combat, dialogue, exploration)",
      "items": {
        "type": "string"
      }
    },
    "ending": {
      "type": "object",
      "description": "If present, marks this scene as an ending",
      "required": ["type", "title"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["victory", "defeat", "neutral", "secret"]
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "description": {
          "type": "string"
        },
        "achievementId": {
          "type": "string"
        }
      }
    }
  },
  "$defs": {
    "conditionGroup": {
      "oneOf": [
        {
          "type": "object",
          "required": ["operator", "conditions"],
          "properties": {
            "operator": {
              "type": "string",
              "enum": ["AND", "OR", "NOT"]
            },
            "conditions": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/condition"
              }
            }
          }
        },
        {
          "$ref": "#/$defs/condition"
        }
      ]
    },
    "condition": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "flag"],
          "properties": {
            "type": {
              "const": "flag"
            },
            "flag": {
              "type": "string",
              "pattern": "^[a-z_][a-z0-9_]*$"
            },
            "value": {
              "type": "boolean",
              "default": true
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "itemId"],
          "properties": {
            "type": {
              "const": "has_item"
            },
            "itemId": {
              "type": "string",
              "pattern": "^[a-z0-9_-]+$"
            },
            "quantity": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "statId"],
          "properties": {
            "type": {
              "const": "stat_check"
            },
            "statId": {
              "type": "string",
              "pattern": "^[a-z0-9_]+$"
            },
            "operator": {
              "type": "string",
              "enum": ["gte", "lte", "gt", "lt", "eq"],
              "default": "gte"
            },
            "value": {
              "type": "number"
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "factionId"],
          "properties": {
            "type": {
              "const": "faction_reputation"
            },
            "factionId": {
              "type": "string",
              "pattern": "^[a-z0-9_-]+$"
            },
            "operator": {
              "type": "string",
              "enum": ["gte", "lte", "gt", "lt", "eq"],
              "default": "gte"
            },
            "value": {
              "type": "number"
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "sceneId"],
          "properties": {
            "type": {
              "const": "visited"
            },
            "sceneId": {
              "type": "string"
            },
            "count": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "choiceId"],
          "properties": {
            "type": {
              "const": "choice_made"
            },
            "choiceId": {
              "type": "string"
            }
          }
        }
      ]
    },
    "effect": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "flag"],
          "properties": {
            "type": {
              "const": "set_flag"
            },
            "flag": {
              "type": "string",
              "pattern": "^[a-z_][a-z0-9_]*$"
            },
            "value": {
              "type": "boolean",
              "default": true
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "flag"],
          "properties": {
            "type": {
              "const": "clear_flag"
            },
            "flag": {
              "type": "string",
              "pattern": "^[a-z_][a-z0-9_]*$"
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "itemId"],
          "properties": {
            "type": {
              "const": "add_item"
            },
            "itemId": {
              "type": "string",
              "pattern": "^[a-z0-9_-]+$"
            },
            "quantity": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "itemId"],
          "properties": {
            "type": {
              "const": "remove_item"
            },
            "itemId": {
              "type": "string",
              "pattern": "^[a-z0-9_-]+$"
            },
            "quantity": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            },
            "all": {
              "type": "boolean",
              "description": "If true, removes all of the item regardless of quantity",
              "default": false
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "statId", "value"],
          "properties": {
            "type": {
              "const": "modify_stat"
            },
            "statId": {
              "type": "string",
              "pattern": "^[a-z0-9_]+$"
            },
            "value": {
              "type": "number"
            },
            "operator": {
              "type": "string",
              "enum": ["add", "subtract", "set", "multiply"],
              "default": "add"
            },
            "min": {
              "type": "number",
              "description": "Optional minimum value cap"
            },
            "max": {
              "type": "number",
              "description": "Optional maximum value cap"
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "factionId", "value"],
          "properties": {
            "type": {
              "const": "modify_reputation"
            },
            "factionId": {
              "type": "string",
              "pattern": "^[a-z0-9_-]+$"
            },
            "value": {
              "type": "integer"
            },
            "min": {
              "type": "integer",
              "minimum": -100,
              "maximum": 100
            },
            "max": {
              "type": "integer",
              "minimum": -100,
              "maximum": 100
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "sceneId"],
          "properties": {
            "type": {
              "const": "goto"
            },
            "sceneId": {
              "type": "string",
              "pattern": "^(sc_|bk_)[a-z0-9_-]+$"
            },
            "immediate": {
              "type": "boolean",
              "description": "If true, bypasses any remaining effects/choices",
              "default": false
            }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "const": "game_over"
            },
            "victory": {
              "type": "boolean",
              "default": false
            },
            "endingId": {
              "type": "string"
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "sceneId"],
          "properties": {
            "type": {
              "const": "mark_visited"
            },
            "sceneId": {
              "type": "string"
            },
            "count": {
              "type": "integer",
              "minimum": 1
            }
          }
        }
      ]
    }
  }
}
