{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/adrianleb/gamebook-web2/content/schemas/manifest-schema.json",
  "title": "Gamebook Manifest",
  "description": "Root manifest defining game structure: acts, hubs, endings, and scene index for The Understage gamebook adaptation",
  "type": "object",
  "required": ["gameId", "title", "startSceneId", "endings", "sceneIndex"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference for validation"
    },
    "gameId": {
      "type": "string",
      "description": "Unique identifier for the game",
      "pattern": "^[a-z0-9_-]+$"
    },
    "title": {
      "type": "string",
      "description": "Display title of the game",
      "minLength": 1
    },
    "subtitle": {
      "type": "string",
      "description": "Optional subtitle"
    },
    "version": {
      "type": "string",
      "description": "Content version (semantic versioning)",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "startSceneId": {
      "type": "string",
      "description": "ID of the opening scene",
      "minLength": 1
    },
    "acts": {
      "type": "array",
      "description": "Optional act/chapter divisions for narrative structure",
      "items": {
        "type": "object",
        "required": ["id", "title"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_-]+$"
          },
          "title": {
            "type": "string",
            "minLength": 1
          },
          "description": {
            "type": "string"
          },
          "startSceneId": {
            "type": "string",
            "description": "Optional override starting scene for this act"
          },
          "endSceneId": {
            "type": "string",
            "description": "Scene that concludes this act"
          }
        }
      }
    },
    "hubs": {
      "type": "object",
      "description": "Named hubs/locations that scenes can reference",
      "additionalProperties": {
        "type": "object",
        "required": ["id", "title"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_-]+$"
          },
          "title": {
            "type": "string",
            "minLength": 1
          },
          "description": {
            "type": "string"
          },
          "scenes": {
            "type": "array",
            "description": "Scene IDs belonging to this hub",
            "items": {
              "type": "string"
            }
          }
        }
      }
    },
    "endings": {
      "type": "array",
      "description": "All possible ending scenes with their achievement conditions",
      "items": {
        "type": "object",
        "required": ["id", "sceneId", "title"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_-]+$"
          },
          "sceneId": {
            "type": "string",
            "description": "Scene ID that triggers this ending",
            "minLength": 1
          },
          "title": {
            "type": "string",
            "description": "Display name of the ending",
            "minLength": 1
          },
          "description": {
            "type": "string",
            "description": "Flavor text for the ending"
          },
          "type": {
            "type": "string",
            "enum": ["victory", "defeat", "neutral", "secret"],
            "description": "Category of ending"
          },
          "faction": {
            "type": "string",
            "description": "Associated faction (if applicable)"
          },
          "conditions": {
            "description": "Conditions for this ending variant (uses scene condition schema)",
            "$ref": "#/$defs/conditionGroup"
          },
          "achievementId": {
            "type": "string",
            "description": "Optional achievement identifier"
          }
        }
      }
    },
    "sceneIndex": {
      "type": "array",
      "description": "Complete index of all scene IDs in the game",
      "items": {
        "type": "object",
        "required": ["id", "file"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique scene identifier",
            "pattern": "^(sc_|bk_)[a-z0-9_-]+$"
          },
          "file": {
            "type": "string",
            "description": "Path to scene JSON file relative to /content/scenes/"
          },
          "title": {
            "type": "string",
            "description": "Scene title for debugging/indexing"
          },
          "actId": {
            "type": "string",
            "description": "Optional act membership"
          },
          "hubId": {
            "type": "string",
            "description": "Optional hub membership"
          },
          "tags": {
            "type": "array",
            "description": "Optional tags for categorization",
            "items": {
              "type": "string"
            }
          },
          "unreachable": {
            "type": "boolean",
            "description": "Mark as true if scene is intentionally unreachable (with documented rationale)",
            "default": false
          },
          "unreachableReason": {
            "type": "string",
            "description": "Required if unreachable=true"
          }
        }
      }
    },
    "factions": {
      "type": "object",
      "description": "Game factions and their relationships",
      "additionalProperties": {
        "type": "object",
        "required": ["id", "name"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_-]+$"
          },
          "name": {
            "type": "string",
            "minLength": 1
          },
          "color": {
            "type": "string",
            "description": "Hex color for UI theming",
            "pattern": "^#[0-9a-fA-F]{6}$"
          },
          "description": {
            "type": "string"
          },
          "allies": {
            "type": "array",
            "description": "Faction IDs that are allies",
            "items": {
              "type": "string"
            }
          },
          "enemies": {
            "type": "array",
            "description": "Faction IDs that are enemies",
            "items": {
              "type": "string"
            }
          }
        }
      }
    }
  },
  "$defs": {
    "conditionGroup": {
      "oneOf": [
        {
          "type": "object",
          "required": ["operator", "conditions"],
          "properties": {
            "operator": {
              "type": "string",
              "enum": ["AND", "OR", "NOT"]
            },
            "conditions": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/condition"
              }
            }
          }
        },
        {
          "$ref": "#/$defs/condition"
        }
      ]
    },
    "condition": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "flag"],
          "properties": {
            "type": {
              "const": "flag"
            },
            "flag": {
              "type": "string",
              "pattern": "^[a-z_][a-z0-9_]*$"
            },
            "value": {
              "type": "boolean",
              "default": true
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "itemId"],
          "properties": {
            "type": {
              "const": "has_item"
            },
            "itemId": {
              "type": "string",
              "pattern": "^[a-z0-9_-]+$"
            },
            "quantity": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "statId"],
          "properties": {
            "type": {
              "const": "stat_check"
            },
            "statId": {
              "type": "string",
              "pattern": "^[a-z0-9_]+$"
            },
            "operator": {
              "type": "string",
              "enum": ["gte", "lte", "gt", "lt", "eq"],
              "default": "gte"
            },
            "value": {
              "type": "number"
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "factionId"],
          "properties": {
            "type": {
              "const": "faction_reputation"
            },
            "factionId": {
              "type": "string",
              "pattern": "^[a-z0-9_-]+$"
            },
            "operator": {
              "type": "string",
              "enum": ["gte", "lte", "gt", "lt", "eq"],
              "default": "gte"
            },
            "value": {
              "type": "number"
            }
          }
        },
        {
          "type": "object",
          "required": ["type", "sceneId"],
          "properties": {
            "type": {
              "const": "visited"
            },
            "sceneId": {
              "type": "string"
            },
            "count": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          }
        }
      ]
    }
  }
}
