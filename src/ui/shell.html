<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Understage â€” DOS UI Shell</title>

  <!-- Preload VT323 font for performance -->
  <link rel="preload" href="https://fonts.gstatic.com/s/vt323/v15/pxiKyp0ihN8qnMr.woff2"
        as="font" type="font/woff2" crossorigin>

  <!-- Load VT323 font (SIL Open Font License) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">

  <!-- DOS UI styles -->
  <link rel="stylesheet" href="shell.css">
</head>
<body>
  <!-- Main game container -->
  <div class="game-container">

    <!-- HEADER -->
    <header class="game-header">
      <h1 class="game-title">The Understage</h1>
      <div class="header-actions">
        <button class="menu-button" id="btn-menu" aria-label="Open menu">MENU</button>
        <button class="menu-button" id="btn-save" aria-label="Save game">SAVE</button>
        <button class="menu-button" id="btn-load" aria-label="Load game">LOAD</button>
      </div>
    </header>

    <!-- MAIN TEXT VIEWPORT -->
    <main id="main-text"
          class="text-viewport"
          data-test-id="main-text-viewport"
          role="region"
          aria-label="Scene text"
          aria-live="polite"
          tabindex="0">
      <!-- Scene text will be rendered here by GameRenderer -->
      <div id="scene-text" data-test-id="scene-text-content">
        <p class="text-center" style="color: var(--text-secondary);">Loading...</p>
      </div>
    </main>

    <!-- CHOICES PANEL -->
    <section id="choices-panel" class="choices-panel" data-test-id="choices-panel" aria-label="Available choices">
      <h2 class="choices-header">What do you do?</h2>
      <ul class="choices-list" data-test-id="choices-list" role="listbox">
        <!-- Choices will be rendered here by GameRenderer -->
      </ul>
    </section>

    <!-- BOTTOM PANEL: Stats + Inventory -->
    <div class="bottom-panel">

      <!-- STATS PANEL -->
      <aside id="stats-panel"
             class="stats-panel"
             data-test-id="stats-panel"
             role="region"
             aria-label="Character stats">
        <div class="panel-header">Status</div>
        <!-- Stats will be rendered here by GameRenderer -->
      </aside>

      <!-- INVENTORY PANEL -->
      <aside id="inventory-panel"
             class="inventory-panel"
             data-test-id="inventory-panel"
             role="region"
             aria-label="Inventory items">
        <div class="panel-header">Inventory</div>
        <ul class="inventory-list" data-test-id="inventory-list">
          <!-- Inventory items will be rendered here by GameRenderer -->
        </ul>
      </aside>

    </div>
    <!-- End bottom panel -->

  </div>
  <!-- End game container -->

  <!-- ERROR OVERLAY (hidden by default) -->
  <div id="error-overlay"
       class="error-overlay"
       data-test-id="error-overlay"
       role="alertdialog"
       aria-labelledby="error-title"
       aria-describedby="error-text"
       aria-hidden="true">
    <div class="error-message">
      <h2 id="error-title" class="error-title" data-test-id="error-title">Error</h2>
      <p id="error-text" class="error-text" data-test-id="error-message">
        An error occurred. Please reload.
      </p>
      <button id="error-dismiss" class="error-button" data-test-id="error-dismiss">
        Continue
      </button>
    </div>
  </div>

  <!-- LOADING INDICATOR (hidden by default) -->
  <div id="loading-indicator" class="loading-indicator" data-test-id="loading-indicator" aria-hidden="true"></div>

  <!-- ENGINE & RENDERER INITIALIZATION -->
  <script type="module">
    import { Engine } from '../engine/engine.js';
    import { GameRenderer } from './game-renderer.js';

    /**
     * Initialize the game.
     * Creates Engine instance, initializes content, and connects GameRenderer.
     */
    async function initializeGame() {
      try {
        console.log('[DOS UI Shell] Initializing...');

        // Create Engine instance
        const engine = new Engine({
          contentPath: '../content',
          cacheScenes: true,
        });

        // Initialize engine (loads manifest and starting scene)
        await engine.initialize();

        console.log('[DOS UI Shell] Engine initialized');

        // Create and initialize GameRenderer
        const renderer = new GameRenderer(engine);
        await renderer.initialize();

        console.log('[DOS UI Shell] GameRenderer initialized');

        // Expose for debugging (development only)
        if (typeof window !== 'undefined') {
          (window as any).__GAME_ENGINE__ = engine;
          (window as any).__GAME_RENDERER__ = renderer;
        }

        // Emit font-ready event after VT323 loads
        if (document.fonts) {
          document.fonts.ready.then(() => {
            console.log('[DOS UI Shell] VT323 font loaded');
          });
        }
      } catch (error) {
        console.error('[DOS UI Shell] Initialization failed:', error);
        const errorOverlay = document.querySelector('[data-test-id="error-overlay"]');
        const errorText = document.querySelector('[data-test-id="error-message"]');
        if (errorOverlay && errorText) {
          errorText.textContent = `Failed to initialize: ${error instanceof Error ? error.message : 'Unknown error'}`;
          errorOverlay.classList.add('visible');
          errorOverlay.setAttribute('aria-hidden', 'false');
        }
      }
    }

    // Error overlay handler
    document.getElementById('error-dismiss')?.addEventListener('click', () => {
      const overlay = document.getElementById('error-overlay');
      if (overlay) {
        overlay.classList.remove('visible');
        overlay.setAttribute('aria-hidden', 'true');
      }
    });

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeGame);
    } else {
      initializeGame();
    }
  </script>

</body>
</html>
